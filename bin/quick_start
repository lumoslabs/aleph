#!/usr/bin/env ruby
$LOAD_PATH.unshift File.dirname(__FILE__)

require 'highline/import'
require 'configuration_helper'

DEFAULT_CONFIGURATION_PATH = '/tmp/aleph/configuration'

say 'Hi! Welcome to Aleph quick setup!'

# * run migrations *
# ==================
if agree('To get started, we need to do some set up, begin?') { |x| x.default = 'yes' }
  if agree('Aleph requires redis. If you have redis installed already you can skip this. Install redis?') { |x| x.default = 'yes' }
  say 'installing redis'
  #system 'brew install redis'

  ConfigurationUtils.merge_to_env(redis_url: 'redis://localhost:6379')
  ConfigurationUtils.merge_to_env(aleph_query_exec_worker_pool: 1)
  ConfigurationUtils.merge_to_env(aleph_alert_exec_worker_pool: 1)
  say 'Done.'

  say 'Running migrations as needed ... '
  system 'RAILS_ENV=playground bundle exec rake db:migrate'
  say 'Done.'
  else
    # ??? what do we do here?
  end
else
  say 'Ok, Bye!'
  exit
end

# * config path *
# ===============
say 'Now we need to configure a few things ... '
config_path = ask('Please specify a configuration path') do |ac|
  ac.default = DEFAULT_CONFIGURATION_PATH
end

configurator = Configurator.new(config_path)



say 'Writing some default configurations'
configurator.write_default_config_yml
say 'Done'

# * redshift connection *
# =======================
redshift_configured = true

if agree("Do you have a Redshift connection you would like to configure?") { |x| x.default = 'no' }
  host = ask('What is the hostname?')
  database = ask('What is the database name?')
  port = ask('What is the port') { |x| x.default = '5439' }
  user = ask('What is the username?')
  password = ask('What is the password?')

  configurator.write_redshift(host, database, port, user, password)
else
  if agree("Would you like to connect to the sample Redshift connection?") { |x| x.default = 'yes' }
    configurator.write_redshift('aleph.pub.playground', 'warehouse', '5439', 'read_only', '********')
  else
    redshift_configured = false
    say "Ok, you can set up your Redshift connection later by editing #{configurator_path}/redshift.yml"
  end
end

if redshift_configured && agree("Ok, aleph is configured. Do you want to run it now?") { |x| x.default = 'no' }
  say 'Check out localhost:3000!'
  system 'RAILS_ENV=playground bundle exec foreman start'
end
